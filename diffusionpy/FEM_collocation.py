from numba import njit,config,prange
import numpy as np
# config.DISABLE_JIT = True
@njit(['Tuple((i8,i8,f8[:,::1],f8[::1]))(i8)'],cache=True)
def collocation_matrices(nz_1):
    nP=4
    nP=2
    nP=3
    nP=2
    nP=5
    nP=8
    nP=5
    nP=11
    nP=4
    nP=2
    nE=(nz_1-1)//(nP-1)
    # NS=[0.0, 0.2928932188134524, 0.7071067811865476, 1.0]
    # S=[[-5.828427124746187, 8.242640687119275, -3.414213562373087, 0.9999999999999973], [-1.4142135623730971, -0.41421356237309154, 2.414213562373092, -0.5857864376269044], [0.5857864376269034, -2.4142135623730896, 0.414213562373088, 1.4142135623730976], [-0.9999999999999956, 3.414213562373087, -8.242640687119275, 5.828427124746187]]
    S=[[-1.,1.],[-1.,1.]]
    NS=[0.,1.]
    # NS=[0.0, 0.5, 1.0]
    # S=[[-3.0, 4.0, -1.0], [-1.0, 0.0, 1.0], [1.0, -4.0, 3.0]]
    # S=[[-6.5395375879962145, 10.061416435370653, -4.600510143711965, 1.2084878521439109, -0.12985655580640643], [-1.5819767068692774, -1.4367492169390943, 3.6769743039405682, -0.7281502458386651, 0.06990186570648914], [0.8515790568112862, -4.328810898082833, 2.000000000000109, 1.592480534123506, -0.11524869285191049], [-1.404016504647432, 5.380343014951867, -9.995052434112738, 5.436749216939184, 0.5819767068693127], [7.0899277167048895, -24.273127375459666, 33.99342753558555, -27.349765464826607, 10.53953758799615]]
    # S=[[-2.1234707894061233, 2.4764575053609614, -0.3529867159548379], [-1.5819767068693262, 1.0000000000000009, 0.5819767068693262], [2.608238646367598, -6.731709435773721, 4.123470789406124]]
    # NS=[0.0, 0.5, 1.0]

    # S=[[-0.5819767068693265, 0.5819767068693265], [-1.5819767068693265, 1.5819767068693265]]
    # S=[[-1., 1.], [-1., 1.]]
    
    #Radial Base nP=5
    # S=[[-7.385281685288774, 13.385631551684405, -9.443225861007644, 4.438728687575403, -0.9896587908253456], 
    # [-1.1937563700993785, -2.8593276665181273, 5.65114525416045, -1.9948011454060215, 0.39585436260312923],
    # [0.42138477552973713, -2.8276008161096158, 3.917710006473666e-14, 2.827600816109679, -0.42138477552960263], 
    # [-0.39585436260325335, 1.9948011454070163, -5.651145254161123, 2.859327666518728, 1.1937563700992773], 
    # [0.9896587908250366, -4.438728687573662, 9.443225861004747, -13.385631551681982, 7.385281685287919]]
    #Radial Base nP=8
    # S=[[-17.177190087359055, 43.494373466457446, -60.24839394161501, 64.31438096920364, -48.21236305108224, 24.06427003629633, -7.231482165253835, 0.9966070118419809], [-1.1264261148731871, -9.455139099653135, 19.395488294274912, -15.530479561574117, 10.350061314704934, -4.843827557942674, 1.3975737113698008, -0.1872824016326519], [0.20321203972374946, -2.52601003168619, -5.066418208711266, 11.211726172062734, -5.604696077325261, 2.331876619556822, -0.6308455452125676, 0.0811664863344402], [-0.08454791947682452, 0.7883336186486258, -4.3698176038648135, -1.6110286410068826, 6.9995143583739265, -2.1844540879789003, 0.5253735602996455, -0.0633801638690377], [0.06338022039707054, -0.5253739037631878, 2.184455144677222, -6.999516010875369, 1.6110302284156826, 4.369816669731404, -0.7883332467029683, 0.08454785406351528], [-0.08116647951955223, 0.6308455522534995, -2.331876445729423, 5.604695807354331, -11.211725912483544, 5.066418061573018, 2.5260100970657158, -0.20321206419022148], [0.1872822771303011, -1.3975728565718204, 4.843825264858883, -10.350057563901887, 15.530475724264301, -19.39548584409935, 9.455138173379718, 1.1264262531632043], [-0.9966065330609033, 7.231479199149247, -24.064261459967863, 48.21234899072219, -64.31436634658851, 60.24838477069289, -43.49437007033248, 17.177189516497144]]
    
    #Radial Base nP=5 nE=5
    # S=[[-16.648810853746472, 31.937493996747403, -23.919578666294303, 10.621926471623826, -1.9910300545547346], [-2.0038608562355513, -6.653465171365331, 11.98352522745583, -3.9912359514521847, 0.6650284347906154], [0.667349070605662, -5.3345871417943105, -0.00035559161701016366, 5.335043922863161, -0.66746699514766], [-0.6649398926300726, 3.990871280110407, -11.983001000494669, 6.653098549579551, 2.0039482087878784], [1.9917370837604196, -10.624768872216812, 23.923820434542268, -31.94033279066212, 16.64951629686505]]
    # S=[[-41.622017751000236, 79.8436974432513, -59.798899879575, 26.55479390442868, -4.977565283788703], [-5.009662004840736, -16.633615863899685, 29.958761545323824, -9.978077124440613, 1.6625650264369987], [1.6683725894484205, -13.336462741218691, -0.000877098624531372, 13.337602526036044, -1.6686675766248762], [-1.662339760515536, 9.977150721380276, -29.957442924651527, 16.632705059176917, 5.009876920553136], [4.979329180300788, -26.561892821799646, 59.80948414872073, -79.85080454044696, 41.623780558521496]]
    #Radial base QR nP+21
    # S=[[-71.94479401781476, 399.8100616930251, -1898.290917966926, 7590.317014422463, -24186.27433721538, 61899.83893858968, -128928.9878937931, 220982.4498760242, -314170.1501398861, 372321.8841689218, -368589.4505526324, 304626.9948690431, -209446.7650146982, 118990.5484460136, -55255.27960509601, 20633.27921639508, -6046.568433165373, 1339.467669368669, -210.921206079227, 21.04263403741998, -0.9999999583211472], [-1.000475071149244, -50.94579393035872, 189.9192741996906, -569.5442219817994, 1613.184303893397, -3870.577864400046, 7739.41430980854, -12896.76690071675, 17961.10879065123, -20953.05548910834, 20486.91986293583, -16762.44432843414, 11429.79641742771, -6448.383377822767, 2976.697766820396, -1105.879369096655, 322.636853520795, -71.19302587940854, 11.17172167673344, -1.111111073642875, 0.0526565807165138], [0.0526789645203227, -2.10615800635484, -39.89416226391544, 119.9550123599345, -254.8215779619485, 543.4699043409622, -1018.776839379367, 1629.757733878358, -2206.687766359032, 2521.739751400319, -2427.113833635903, 1961.353133441028, -1324.012650989865, 740.798962537806, -339.5922752659723, 125.4161296811279, -36.40308183810658, 7.997000637459298, -1.249999966683252, 0.1238916437197195, -0.0058532180848371], [-0.0058554134533952, 0.1755789911604298, -3.334583457976203, -32.1173843986414, 84.97238189610586, -135.9184315541405, 226.4797599195513, -339.6601990973887, 441.5030719088492, -490.5221809016772, 462.4807802144848, -367.8916346034264, 245.2794829632671, -135.864078450377, 61.76720653032672, -22.65307159541713, 6.536336954581381, -1.42857139941701, 0.2223055586812719, -0.0219473733196934, 0.0010333082263136], [0.0010336441061114, -0.0275507542776854, 0.3924314444504129, -4.707411878906445, -25.94191372290855, 63.9824039526797, -79.96001346325046, 106.594697156997, -129.8960504651272, 138.5453966477844, -126.9967721004696, 98.9609973582173, -64.948024907905, 35.53156545258421, -15.99200253277816, 5.816582104834484, -1.666666641677395, 0.3621085997364319, -0.0560616338012261, 0.0055101507317933, -0.0002584110200558], [-0.0002584820928836, 0.0064589838501157, -0.0817790350600337, 0.7357353875648895, -6.25171883526783, -20.69291363541099, 49.98875224447433, -49.98000572794324, 54.13823906643547, -54.13417916656256, 47.63688678908436, -36.08945270255463, 23.20210236041199, -12.49500135392979, 5.554305758680448, -1.999999979179497, 0.5683380688345285, -0.1226225628076587, 0.0188720846997908, -0.0018454239226778, 8.616069582865906e-05], [8.618008416681661e-05, -0.0020673398885681, 0.0245392307229822, -0.1962402484750577, 1.250625101041307, -8.001800044149014, -16.02724688124147, 39.99300122068401, -32.49025230167779, 28.87805850703483, -23.82380270053924, 17.32683507535104, -10.83008406446971, 5.713285860111886, -2.499999983339328, 0.8890888863883936, -0.2501250177083314, 0.0535200671419674, -0.0081797434653908, 0.0007951307144816, -3.693432117008914e-05], [-3.694078524346776e-05, 0.0008615423627747, -0.0098174100261022, 0.0736029713906207, -0.4169479865933667, 2.000800089160424, -10.00174999894158, -11.74253250803068, 32.49593810593397, -21.66233413670316, 15.88531458889856, -10.83116705481694, 6.499187604944282, -3.333333320837889, 1.42882142127906, -0.500200019165381, 0.1389826611560509, -0.0294411882988402, 0.0044624590582037, -0.0004307711765504, 1.989119180196212e-05], [1.989367835618088e-05, -0.0004544967305749, 0.0050351985438185, -0.0362398382586838, 0.1924615862235169, -0.8209436643588325, 3.077846210245702, -12.30923072947329, -7.705070882073759, 26.66466691388023, -14.66520019555004, 8.888222297228626, -4.999999991676885, 2.461846139748109, -1.025948733333693, 0.3518329975474014, -0.0962307926315771, 0.0201332433599249, -0.0030211191062276, 0.0002892251900361, -1.326245212665239e-05], [-1.326344684929356e-05, 0.0002982858476289, -0.0032371561016309, 0.0226515975434241, -0.1154856119648057, 0.4618154426956285, -1.539038517785376, 4.616307701916234, -15.00112494218381, -3.817181905681787, 21.99945005271106, -9.999999995840636, 5.000374976568566, -2.308153848078589, 0.9234231091355476, -0.3078769611572988, 0.0824897226264148, -0.0169886981082297, 0.0025177880707082, -0.0002386286772182, 1.085191101462964e-05], [1.085218231671812e-05, -0.0002410450938582, 0.0025750749016518, -0.0176510366956688, 0.0874912869346288, -0.335874172200859, 1.049370674813019, -2.797832180921711, 6.818863607926845, -18.18227269125764, -3.1945673819019326e-11, 18.18227269131634, -6.818863607972323, 2.797832180951334, -1.049370674829132, 0.3358741722081214, -0.0874912869373128, 0.0176510366964711, -0.0025750749018384, 0.0002410450938899, -1.085218231688953e-05], [-1.085191100777624e-05, 0.0002386286771795, -0.0025177880704945, 0.0169886981074634, -0.0824897226242398, 0.3078769611524362, -0.9234231091270084, 2.308153848067004, -5.000374976557027, 9.999999995833738, -21.99945005271222, 3.817181905690719, 15.00112494217092, -4.616307701903984, 1.539038517776635, -0.4618154426907668, 0.1154856119626704, -0.0226515975426858, 0.0032371561014262, -0.0002982858475863, 1.326344684630303e-05], [1.326245212767543e-05, -0.0002892251899925, 0.0030211191060197, -0.0201332433591971, 0.0962307926294888, -0.3518329975427013, 1.025948733325308, -2.461846139736401, 4.999999991664467, -8.888222297219682, 14.66520019554792, -26.66466691388517, 7.705070882082774, 12.30923072946408, -3.077846210238887, 0.8209436643549772, -0.1924615862218012, 0.0362398382580991, -0.0050351985436448, 0.0004544967305394, -1.989367835612844e-05], [-1.989119180833486e-05, 0.0004307711765187, -0.004462459058089, 0.0294411882984268, -0.1389826611548703, 0.500200019162841, -1.428821421274843, 3.333333320832688, -6.499187604940057, 10.83116705481621, -15.88531458890275, 21.6623341367114, -32.49593810594365, 11.74253250803905, 10.00174999893602, -2.000800089157504, 0.4169479865921315, -0.0736029713902087, 0.0098174100259976, -0.000861542362751, 3.694078523995135e-05], [3.693432117206077e-05, -0.0007951307144301, 0.0081797434651866, -0.0535200671413091, 0.2501250177067051, -0.8890888863854405, 2.499999983335892, -5.713285860111078, 10.83008406447664, -17.32683507537018, 23.82380270057076, -28.8780585070732, 32.49025230171448, -39.99300122071214, 16.02724688125891, 8.001800044140204, -1.250625101037727, 0.1962402484739104, -0.0245392307226966, 0.0020673398885119, -8.618008417022512e-05], [-8.616069582342713e-05, 0.0018454239225897, -0.0188720846993556, 0.1226225628063049, -0.5683380688311385, 1.999999979173304, -5.554305758673021, 12.49500135392727, -23.20210236042447, 36.08945270259098, -47.63688678914491, 54.13417916663646, -54.13823906650605, 49.98000572799724, -49.98875224450776, 20.69291363542781, 6.251718835261043, -0.7357353875627295, 0.0817790350594961, -0.0064589838500225, 0.0002584820928694], [0.0002584110200856, -0.0055101507315657, 0.056061633800121, -0.3621085997328884, 1.666666641668516, -5.816582104818459, 15.99200253275978, -35.53156545258052, 64.94802490794333, -98.96099735832088, 126.996772100638, -138.5453966479872, 129.8960504653189, -106.5946971571424, 79.96001346333979, -63.98240395272413, 25.94191372292627, 4.707411878900809, -0.3924314444489646, 0.0275507542774386, -0.001033644106084], [-0.0010333082262998, 0.0219473733188385, -0.2223055586773461, 1.428571399404186, -6.536336954549956, 22.65307159536313, -61.76720653027354, 135.8640784503953, -245.2794829634637, 367.8916346038854, -462.4807802151942, 490.5221809025084, -441.5030719096209, 339.6601990979664, -226.4797599199024, 135.9184315543137, -84.97238189617484, 32.1173843986633, 3.334583457970704, -0.1755789911593904, 0.0058554134533283], [0.0058532180849623, -0.1238916437153367, 1.249999966662397, -7.997000637393842, 36.40308183795369, -125.4161296808861, 339.5922752657985, -740.7989625381135, 1324.01265099124, -1961.353133443892, 2427.113833640123, -2521.739751405127, 2206.687766363412, -1629.75773388159, 1018.776839381308, -543.4699043419096, 254.8215779623217, -119.9550123600512, 39.89416226394481, 2.106158006349689, -0.0526789645203124], [-0.0526565807142567, 1.111111073603791, -11.17172167655764, 71.19302587888819, -322.6368535196303, 1105.879369095013, -2976.697766819905, 6448.38337782729, -11429.7964174424, 16762.4443284624, -20486.91986297589, 20953.05548915292, -17961.10879069117, 12896.76690074584, -7739.41430982582, 3870.577864408401, -1613.184303896656, 569.5442219828109, -189.9192741999417, 50.94579393040384, 1.000475071144874], [0.9999999584385164, -21.0426340366276, 210.9212060761997, -1339.467669359848, 6046.568433146402, -20633.27921637226, 55255.27960510416, -118990.548446129, 209446.7650150178, -304626.9948696251, 368589.4505534343, -372321.8841697979, 314170.1501406603, -220982.449876582, 128928.9878941213, -61899.83893874697, 24186.27433727626, -7590.317014441269, 1898.290917971531, -399.8100616938648, 71.94479401785702]]
    #Radial base QR nP+11
    # S=[[-29.27968437301582, 99.9100568064934, -224.6403522433512, 399.161029072473, -523.7417272709887, 502.7417831640137, -349.161139875288, 171.069001055031, -56.16008244482937, 11.101115942795, -0.9999998333333838], [-1.000900238304817, -18.28168400634919, 44.9685167184396, -59.92805596737552, 69.89509688336227, -62.89929737015264, 41.93705701169584, -19.97601759040419, 6.424073302994055, -1.249999866666688, 0.1112111227612802], [0.1112889978002934, -2.223778033258115, -12.17257252857142, 26.65333906491157, -23.3146773953972, 18.6498770218805, -11.65733846455183, 5.330667599755592, -1.666666566666664, 0.3176825507651279, -0.0278222466678493], [-0.0278361612695429, 0.4171668722288653, -3.751875118653114, -7.591238828571408, 17.49475172047462, -10.49580153960805, 5.831583829070392, -2.499999933333298, 0.7503749937156047, -0.1390556166599871, 0.0119297826059139], [0.0119333620775904, -0.1589683865281652, 1.072285892817129, -5.715999933261914, -3.664667033333327, 11.99880025997801, -4.999999966666678, 1.905333285682868, -0.5361429356857109, 0.0953810293734098, -0.0079555744532081], [-0.0079563700504314, 0.0993651746201018, -0.5957739434282655, 2.381904761853974, -8.334166541651395, -8.710291350079534e-15, 8.3341665416514, -2.381904761853967, 0.5957739434282597, -0.0993651746200972, 0.0079563700504302], [0.0079555744532091, -0.0953810293734094, 0.5361429356857155, -1.905333285682871, 4.999999966666682, -11.99880025997802, 3.664667033333342, 5.715999933261905, -1.072285892817125, 0.1589683865281644, -0.0119333620775894], [-0.0119297826059145, 0.139055616659984, -0.7503749937156003, 2.499999933333296, -5.831583829070391, 10.49580153960806, -17.49475172047464, 7.59123882857142, 3.751875118653107, -0.4171668722288656, 0.0278361612695427], [0.0278222466678479, -0.3176825507651348, 1.666666566666666, -5.330667599755595, 11.65733846455182, -18.6498770218805, 23.3146773953972, -26.65333906491155, 12.1725725285714, 2.223778033258116, -0.1112889978002883], [-0.1112111227612764, 1.249999866666684, -6.424073302994055, 19.97601759040415, -41.93705701169574, 62.89929737015253, -69.89509688336217, 59.9280559673754, -44.96851671843954, 18.28168400634919, 1.000900238304806], [0.999999833333368, -11.10111594279499, 56.16008244482934, -171.0690010550308, 349.1611398752873, -502.7417831640131, 523.7417272709883, -399.1610290724726, 224.640352243351, -99.9100568064936, 29.27968437301585]]
    # NS=[0.0, 0.25, 0.5, 0.75, 1.0]
    # NS=np.linspace(0,1,nP)
    # S=[[-11.678206258747934, 20.70386795479874, -18.333553696781337, 16.39781971743514, -7.089927716704437], [-1.3201990250694249, -2.981778751843959, 7.53904202668126, -5.481697995559616, 2.2446337457917958], [0.2136900545211511, -1.3780529360988296, -2.000000000000434, 4.743330682219098, -1.5789678006410044], [-0.08825493961140973, 0.46267933361394953, -2.1902750822723025, -1.0182212481563409, 2.834071936426088], [0.1298565558064645, -0.6447326169070433, 2.4811766822883516, -9.644506879936397, 7.678206258748568]]
    return nP,nE,np.asarray(S),np.asarray(NS)

@njit(['f8[::1](f8[::1],f8[:,::1],i8,i8)'],cache=True)
def collocation_forward(x,S,nE,nP):
    dx=np.zeros_like(x)
    for i in range(nE):
        P0=i*(nP-1)
        P8=(i+1)*(nP-1)+1
        xP=x[P0:P8]
        if i==0: dxP_=np.zeros_like(xP)
        dxP=S@xP
        if i>0: dxP[0]=dxP_[-1]
        dx[P0:P8]=dxP
        dxP_=dxP
    return dx
@njit(['f8[::1](f8[::1],f8[:,::1],i8,i8)'],cache=True)
def collocation_backward(x,S,nE,nP):
    dx=np.zeros_like(x)
    for i in range(nE-1,-1,-1):
        P0=i*(nP-1)
        P8=(i+1)*(nP-1)+1
        xP=x[P0:P8]
        if i==(nE-1): dxP_=np.zeros_like(xP)
        dxP=S@xP
        if i<(nE-1): dxP[-1]=dxP_[0]
        dx[P0:P8]=dxP
        dxP_=dxP
    return dx

@njit(['f8[::1](f8[::1],i8,b1)'],cache=True)
def collocation(x,nz_1,forward):
    nP,nE,S,NS=collocation_matrices(nz_1)
    if forward:
        return collocation_forward(x,S,nE,nP)
    else:
        return collocation_backward(x,S,nE,nP)

@njit(['Tuple((f8[::1],i8))(i8)'],cache=True)
def collocation_space(nz_1):
    nP,nE,S,NS=collocation_matrices(nz_1)
    z=np.asarray([0.])
    zE=np.linspace(0,1,nE+1)
    for i in range(nE):
        z0=zE[i]
        z8=zE[i+1]
        zP=NS*(z8-z0)+z0
        z=np.hstack((z,zP[1:]))
    return z,nE 
